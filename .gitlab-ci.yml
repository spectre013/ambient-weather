stages:
  - prepare
  - build
  - lint
  - build docker

cache:
  paths:
    - node_modules/
    - .npm


pre-process:
  stage: prepare
  script:
    - ls -l
  artifacts:
    paths:
      - $CI_PROJECT_DIR
    expire_in: 1 day

build:
  stage: build
  script:
    - cd weather-ui
    - npm install

lint server:
  stage: lint
  script:
    - cd weather-server
    - staticcheck ./...
  artifacts:
    paths:
      - $CI_PROJECT_DIR
    expire_in: 1 day

lint ui:
  stage: lint
  script:
    - cd weather-ui
    - ls -l
    - npm run lint
  artifacts:
    paths:
      - $CI_PROJECT_DIR
    expire_in: 1 day


ui:
  stage: build docker
  script:
    - cd weather-ui
    - docker build -t $DOCKER_REGISTRY/production/weather-ui:1.6 .
    - docker push $DOCKER_REGISTRY/production/weather-ui:1.6
  artifacts:
    paths:
      - $CI_PROJECT_DIR
    expire_in: 1 day

server:
  stage: build docker
  script:
    - cd weather-server
    - docker build -t $DOCKER_REGISTRY/production/weather-server:1.7 .
    - docker push $DOCKER_REGISTRY/production/weather-server:1.7
  artifacts:
    paths:
      - $CI_PROJECT_DIR
    expire_in: 1 day

notify:
  stage: build docker
  script:
    - cd weather-notify
    - docker build -t $DOCKER_REGISTRY/production/weather-notify:1.0 .
    - docker push $DOCKER_REGISTRY/production/weather-notify:1.0
  artifacts:
    paths:
      - $CI_PROJECT_DIR
    expire_in: 1 day

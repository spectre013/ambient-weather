stages:
  - build
  - lint
  - build docker

cache:
  untracked: true
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/

build ui:
  stage: build
  script:
    - cd weather-ui
    - npm install


lint server:
  stage: lint
  script:
    - export PATH=$PATH:/usr/local/go/bin
    - cd weather-server
    - staticcheck ./...

lint notify:
  stage: lint
  script:
    - export PATH=$PATH:/usr/local/go/bin
    - cd weather-notify
    - staticcheck ./...

lint ui:
  stage: lint
  script:
    - cd weather-ui
    - npm run lint


ui:
  stage: build docker
  script:
    - cd weather-ui
    - docker build -t $DOCKER_REGISTRY/production/weather-ui:1.7 .
    - docker push $DOCKER_REGISTRY/production/weather-ui:1.7

server:
  stage: build docker
  script:
    - cd weather-server
    - docker build -t $DOCKER_REGISTRY/production/weather-server:1.8 .
    - docker push $DOCKER_REGISTRY/production/weather-server:1.8

notify:
  stage: build docker
  script:
    - cd weather-notify
    - docker build -t $DOCKER_REGISTRY/production/weather-notify:1.1 .
    - docker push $DOCKER_REGISTRY/production/weather-notify:1.1

